<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resource Registration</title>
  <style>
    .hidden { display: none; }
    .related-resource { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Register Resource</h1>
  <form id="resourceForm">
    <label for="resource-type">Resource Type:</label>
    <select id="resource-type" name="resource-type" required>
      <option value="notebook">Notebook</option>
      <option value="dataset">Dataset</option>
      <option value="publication">Publication</option>
      <option value="oer">OER</option>
    </select><br><br>

    <label for="title">Title:</label>
    <input type="text" id="title" name="title" required><br><br>

    <label for="authors">Authors (comma-separated):</label>
    <input type="text" id="authors" name="authors" required><br><br>

    <label for="tags">Tags (comma-separated):</label>
    <input type="text" id="tags" name="tags" required><br><br>

    <label for="contents">Contents:</label>
    <textarea id="contents" name="contents" required></textarea><br><br>

    <div id="notebookFields" class="hidden">
      <label for="html-notebook">HTML Notebook:</label>
      <input type="text" id="html-notebook" name="html-notebook"><br><br>

      <label for="notebook-repo">Notebook Repo:</label>
      <input type="text" id="notebook-repo" name="notebook-repo"><br><br>

      <label for="notebook-file">Notebook File:</label>
      <input type="text" id="notebook-file" name="notebook-file"><br><br>
    </div>

    <div id="datasetFields" class="hidden">
      <label for="external-link">External Link:</label>
      <input type="text" id="external-link" name="external-link"><br><br>

      <!-- File Upload Section -->
      <label for="file-input">Upload Dataset:</label>
      <input type="file" name="file" id="file-input" required><br><br>
      <button type="button" id="upload-button">Upload</button>
      <div id="result"></div>
      <!-- End of File Upload Section -->

      <label for="direct-download-link">Direct Download Link:</label>
      <input type="text" id="direct-download-link" name="direct-download-link"><br><br>

      <label for="size">Size:</label>
      <input type="text" id="size" name="size"><br><br>
    </div>

    <div id="publicationFields" class="hidden">
      <label for="related-notebooks">Related Notebooks:</label>
      <input type="text" id="related-notebooks" name="related-notebooks"><br><br>

      <label for="related-datasets">Related Datasets:</label>
      <input type="text" id="related-datasets" name="related-datasets"><br><br>

      <label for="related-publications">Related Publications:</label>
      <input type="text" id="related-publications" name="related-publications"><br><br>
    </div>

    <div id="oerFields" class="hidden">
      <label for="related-datasets">Related Datasets:</label>
      <input type="text" id="related-datasets" name="related-datasets"><br><br>

      <label for="related-notebooks">Related Notebooks:</label>
      <input type="text" id="related-notebooks" name="related-notebooks"><br><br>

      <label for="external-link">External Link:</label>
      <input type="text" id="external-link" name="external-link"><br><br>
    </div>

    <label for="thumbnail-image">Thumbnail Image:</label>
    <input type="text" id="thumbnail-image" name="thumbnail-image"><br><br>

    <div id="relatedResourcesSection">
      <h3>Related Resources</h3>
      <button type="button" id="addRelatedResource">+</button>
      <button type="button" id="removeRelatedResource">-</button>
    </div>

    <button type="submit">Submit</button>
  </form>

  <script>
    document.getElementById('resource-type').addEventListener('change', function() {
      const resourceType = this.value;
      document.getElementById('notebookFields').classList.add('hidden');
      document.getElementById('datasetFields').classList.add('hidden');
      document.getElementById('publicationFields').classList.add('hidden');
      document.getElementById('oerFields').classList.add('hidden');

      if (resourceType === 'notebook') {
        document.getElementById('notebookFields').classList.remove('hidden');
      } else if (resourceType === 'dataset') {
        document.getElementById('datasetFields').classList.remove('hidden');
      } else if (resourceType === 'publication') {
        document.getElementById('publicationFields').classList.remove('hidden');
      } else if (resourceType === 'oer') {
        document.getElementById('oerFields').classList.remove('hidden');
      }
    });

    document.getElementById('addRelatedResource').addEventListener('click', function() {
      const relatedResourceDiv = document.createElement('div');
      relatedResourceDiv.classList.add('related-resource');

      const resourceTypeSelect = document.createElement('select');
      resourceTypeSelect.name = 'related-resource-type';
      resourceTypeSelect.innerHTML = `
        <option value="notebook">Notebook</option>
        <option value="dataset">Dataset</option>
        <option value="publication">Publication</option>
        <option value="oer">OER</option>
      `;

      const resourceTitleInput = document.createElement('input');
      resourceTitleInput.type = 'text';
      resourceTitleInput.name = 'related-resource-title';
      resourceTitleInput.placeholder = 'Search related resource...';

      const resourceDropdown = document.createElement('div');
      resourceDropdown.classList.add('related-resource-dropdown');
      resourceDropdown.style.position = 'absolute';
      resourceDropdown.style.zIndex = '1000';
      resourceDropdown.style.backgroundColor = '#fff';
      resourceDropdown.style.border = '1px solid #ccc';
      resourceDropdown.style.display = 'none';

      relatedResourceDiv.appendChild(resourceTypeSelect);
      relatedResourceDiv.appendChild(resourceTitleInput);
      relatedResourceDiv.appendChild(resourceDropdown);
      document.getElementById('relatedResourcesSection').appendChild(relatedResourceDiv);

      resourceTitleInput.addEventListener('input', async function() {
        const keyword = this.value;
        const resourceType = resourceTypeSelect.value;
        if (keyword.length > 2) {
          const response = await fetch(`http://localhost:3004/search-resources?type=${resourceType}&keyword=${keyword}`);
          const results = await response.json();
          resourceDropdown.innerHTML = '';
          results.forEach(result => {
            const option = document.createElement('div');
            option.textContent = result.title;
            option.addEventListener('click', function() {
              resourceTitleInput.value = result.title;
              resourceDropdown.style.display = 'none';
            });
            resourceDropdown.appendChild(option);
          });
          resourceDropdown.style.display = 'block';
        } else {
          resourceDropdown.style.display = 'none';
        }
      });
    });

    document.getElementById('removeRelatedResource').addEventListener('click', function() {
      const relatedResources = document.querySelectorAll('.related-resource');
      if (relatedResources.length > 0) {
        const lastRelatedResource = relatedResources[relatedResources.length - 1];
        lastRelatedResource.remove();
      }
    });

    document.getElementById('resourceForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {};

      formData.forEach((value, key) => {
        if (key === 'authors' || key === 'tags') {
          data[key] = value.split(',').map(item => item.trim());
        } else {
          data[key] = value;
        }
      });

      const relatedResources = [];
      document.querySelectorAll('.related-resource').forEach(div => {
        const type = div.querySelector('select[name="related-resource-type"]').value;
        const title = div.querySelector('input[name="related-resource-title"]').value;
        relatedResources.push({ type, title });
      });
      data['related-resources'] = relatedResources;

      const response = await fetch('http://149.165.169.173:3004/resources', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      console.log(result);
    });
    document.getElementById('upload-button').addEventListener('click', async function () {
      const fileInput = document.getElementById('file-input');
      const file = fileInput.files[0];
      
      const formData = new FormData();
      formData.append('file', file);
      
      const response = await fetch('http://149.165.169.173:5000/api/upload', {
          method: 'POST',
          body: formData,
      });
      
      const result = await response.json();
      document.getElementById('result').innerHTML = `
          <p>File uploaded successfully!</p>
          <p>File URL: <a href="${result.url}" target="_blank">${result.url}</a></p>
          <p>File Bucket: ${result.bucket}</p>
          <p>File Key: ${result.key}</p>
      `;
    });
  </script>
</body>
</html>

